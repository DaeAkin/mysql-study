# Mysql



# 실행 계획

DBMS에서는 쿼리를 최적으로 실행하기 위해 각 테이블의 데이터가 어떤 분포로 저장돼 있는지 통계 정보를 참조하며, 그러한 기본 데이터를 비교해 최적의 실행 계획을 수립하는 작업이 필요합니다. DBMS에서는 옵티마이저가 이러한 기능을 담당합니다.

MySQL에서는 EXPLAIN이라는 명령으로 쿼리의 실행계획을 확인할 수 있습니다.



## 쿼리 실행 절차

1. 사용자로부터 요청된 SQL 문장을 잘게 쪼개서 MySQL 서버가 이해할 수 있는 수준으로 분리한다.
2. SQL의 파싱정보(파스 트리)를 확인하면서 어떤 테이블부터 읽고 어떤 인덱스를 이용해 테이블을 읽을지 선택한다.
3. 두 번째 단계에서 결정된 테이블의 읽기 순서나 선택된 인덱스를 이용해 스토리지 엔진으로부터 데이터를 가져온다.

첫 번째 단계를 "SQL 파싱"이라고 하며, MySQL 서버의 "<u>SQL 파서</u>"라는 모듈로 처리합니다. 만약 SQL 문장이 문법적으로 잘못됐다면 이 단계에서 걸러지며 "<u>SQL 파스 트리</u>"가 만들어 집니다. MySQL 서버는 SQL 문장이 아니라 SQL 파스 트리를 이용해 쿼리를 실행합니다.

두번 째 단계는 첫 번째 단계에서 만들어진 SQL 파스 트리를 참조하면서, 다음과 같은 내용을 처리합니다.

- 불필요한 조건의 제거 및 복잡한 연산의 단순화
- 여러 테이블의 조인이 있는 경우 어떤 순서로 테이블을 읽을지 결정
- 각 테이블에 사용된 조건과 인덱스 통계 정볼르 이용해 사용할 인덱스 결정
- 가져온 레코드들을 임시 테이블에 넣고 다시 한번 가공해야 하는지 결정

두 번째 단계는 "최적화 및 실행 계획 수립" 단계이며, MySQL 서버의 "옵티마이저"에서 처리합니다. 또한 쿼리의 "실행 계획"이 만들어집니다.

세 번째 단계는 수립된 실행 계획대로 스토리지 엔진에 레코드를 읽어오도록 요청하고, MySQL 엔진에서는 스토리지 엔진으로부터 받은 레코드를 조인하거나 정렬하는 작업을 수행합니다.

첫 번째와 두 번째는 MySQL 엔진이 처리하며, 세 번째 단계는 MySQL 엔진과 스토리지 엔진이 동시에 참여해서 처리합니다.

### 옵티마이저의 종류

옵티마이저는 데이터베이스의 두뇌 역할이며, 대부분의 DBMS는 **비용 기반 최적화**(Cost-based optimizer, CBO) 방법과 예전 오라클에서 많이 사용하던 **규칙 기반 최적화**(Rule-based optimizer, RBO)로 크게 나눌 수 있습니다.

- **비용 기반**은 쿼리를 처리하기 위한 여러 가지 방법 중에 가장 최소 비용으로 소요되는 처리 방법입니다.
- **규칙 기반**은 테이블의 레코드 건수나 선택도 등을 고려하지 않고, 옵티마이저에 내장된 우선순위에 따라 실행 계획을 수립하는 방법입니다. 통계 정보를 조사하지 않고 실행 계획을 만들기 때문에 같은 쿼리에 대해서는 거의 항상 같은 실행 방법이 만들어 집니다.

### 통계 정보

**비용 기반 최적화**를 이용하려면 가장 중요한 것은 통계정보 입니다. 기본적으로 MySQL에서 관리되는 통계 정보는 대략의 **레코드 건수**와 **인덱스의 유니크한 값의 개수** 정도가 전부 입니다. **오라클과 같은 DBMS에서는 통계 정보가 상당히 정적이고 수집에 많은 시간이 소요되기 때문에 통계 정보만 따로 백업하기도 하지만**, MySQL에서는 통계 정보는 사용자가 알아채지 못하는 순간 자동으로 변경되기 때문에 **동적인** 편 입니다. 하지만 **개발용 MySQL서버처럼** 레코드 건수가 많지 않으면 통계 정보가 부정확 하므로 "**ANALYZE**" 명령으로 강제적으로 통계 정보를 갱신할 수 있습니다.

MEMORY 테이블은 별도의 통계 정보가 없고, MyISAM과 InnoDB의 테이블과 인덱스 통계 정보는 다음과 같이 확인할 수 있습니다.

```sql
SHOW TABLE STATUS LIKE 'tb_test'\g
SHOW INDEX FROM tb_test;
```

통계 정보를 갱신하려면 다음과 같이 ANALYZE를 실행하면 됩니다.

```
--- // 파티션 사용하지 않는 테이블의 정보 수집
ANALYZE TABLE tb_test 

-- // 파티션을 사용하는 테이블에서 특정 파티션의 통계 정보 수집 
ALTER TABLE tb_test ANALYZE PARTITION p3;
```

ANALYZE 명령을 실행하는 동안에는 **MyISAM** 테이블은 읽기는 가능하지만 쓰기는 안되고, **InnoDB 테이블**은 읽기와 쓰기가 모두 불가능하므로 서비스 도중에 실행하지 말아야 합니다. 

**MyISAM**은 정확한 키값 분포도를 위해 전체를 스캔하는데 많은 시간이 소요되며, **InnoDB**는 8개 페이지만 랜덤으로 분석해서 그 결과를 사용합니다.



## 실행 계획 분석